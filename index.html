<!-- Shortie - Telegram Mini App HTML UI with Full Integration -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SHORTIE - Fun N Earn By Watching Video</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
  <style>
    .like-animate { animation: pop 0.3s ease; }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="w-full max-w-md mx-auto">
    <!-- Notifications -->
    <div id="notifications" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">ðŸ”” Notifications</h2>
      <ul id="notification-list" class="space-y-2"></ul>
    </div>

    <!-- Inbox -->
    <div id="inbox" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">ðŸ’¬ Inbox</h2>
      <div id="chat-box" class="h-60 overflow-y-auto border mb-2 p-2"></div>
      <input type="text" id="chat-message" class="border p-1 w-full" placeholder="Type a message...">
      <button onclick="sendMessage()" class="mt-2 bg-green-500 text-white px-3 py-1 rounded">Send</button>
    </div>

    <!-- Music -->
    <div id="music" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">ðŸŽµ Music Library</h2>
      <input type="text" id="music-title" placeholder="Title" class="border p-1 mb-2 w-full">
      <input type="file" id="music-file" accept="audio/*" class="mb-2">
      <button onclick="uploadMusic()" class="bg-indigo-500 text-white px-4 py-1 rounded">Upload Music</button>
      <div id="music-list" class="mt-4"></div>
    </div>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://ydtpzbwauxqxqouysaau.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdHB6YndhdXhxeHFvdXlzYWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjI0MjIsImV4cCI6MjA2NDczODQyMn0.mAUxZcqBLQdzOih6Ty2Eoy_vXmR94BwAcTCQ1j2_1M0'
    );

    let tgUser;
    window.Telegram.WebApp.ready();
    tgUser = window.Telegram.WebApp.initDataUnsafe.user;

    async function sendMessage() {
      const text = document.getElementById('chat-message').value;
      const { error } = await supabase.from('messages').insert({
        sender_id: tgUser.id,
        message: text
      });
      if (!error) document.getElementById('chat-message').value = '';
    }

    supabase.channel('messages').on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'messages'
    }, payload => {
      const msg = payload.new;
      const chat = document.getElementById('chat-box');
      chat.innerHTML += `<p><b>${msg.sender_id}</b>: ${msg.message}</p>`;
      chat.scrollTop = chat.scrollHeight;
    }).subscribe();

    async function uploadMusic() {
      const title = document.getElementById('music-title').value;
      const file = document.getElementById('music-file').files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'shortie_miniapp');

      const res = await fetch('https://api.cloudinary.com/v1_1/djxcrk7yo/video/upload', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      await supabase.from('music_library').insert({
        user_id: tgUser.id,
        title,
        url: data.secure_url
      });
    }

    async function loadNotifications() {
      const { data } = await supabase.from('notifications').select('*').eq('user_id', tgUser.id);
      const list = document.getElementById('notification-list');
      list.innerHTML = data.map(n => `<li class="border p-2">${n.text}</li>`).join('');
    }

    async function approveWithdraw(id) {
      await supabase.from('withdraw_requests').update({ status: 'approved' }).eq('id', id);
      await supabase.from('notifications').insert({ user_id: tgUser.id, text: `Withdraw #${id} approved` });
    }

    async function rejectWithdraw(id) {
      await supabase.from('withdraw_requests').update({ status: 'rejected' }).eq('id', id);
      await supabase.from('notifications').insert({ user_id: tgUser.id, text: `Withdraw #${id} rejected` });
    }
  </script>
</body>
</html>
