<!-- Shortie - Telegram Mini App HTML UI with Full Integration -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SHORTIE - Fun N Earn By Watching Video</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .like-animate {
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="w-full max-w-md mx-auto">
    <!-- Top Bar with Search and Notification -->
    <div class="flex justify-between items-center px-4 py-2 bg-white shadow">
      <input type="text" placeholder="🔍 Search" class="border px-2 py-1 rounded w-2/3" id="search-input">
      <div class="relative">
        <button onclick="navigate('notifications')">🔔</button>
        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1 hidden">0</span>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t flex justify-around py-2 z-10">
      <button onclick="navigate('home')">🏠</button>
      <button onclick="navigate('upload')">➕</button>
      <button onclick="navigate('inbox')">💬</button>
      <button onclick="navigate('wallet')">💰</button>
      <button onclick="navigate('profile')">👤</button>
    </div>

    <!-- Screens -->
    <div id="home" class="screen p-4"> 
      <h2 class="text-xl font-bold mb-2">🎥 Feed</h2>
      <div id="video-feed" class="space-y-4"></div>
    </div>

    <div id="upload" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">➕ Upload</h2>
      <input type="file" id="video-file" accept="video/*" class="mb-2">
      <input type="text" id="music-id" placeholder="Music ID (optional)" class="border p-1 mb-2 w-full">
      <button onclick="uploadVideo()" class="bg-blue-500 text-white px-4 py-1 rounded">Upload</button>
    </div>

    <div id="inbox" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">💬 Inbox</h2>
      <div id="chat-box" class="h-60 overflow-y-auto border mb-2 p-2"></div>
      <input type="text" id="chat-message" class="border p-1 w-full" placeholder="Type a message...">
      <button onclick="sendMessage()" class="mt-2 bg-green-500 text-white px-3 py-1 rounded">Send</button>
    </div>

    <div id="wallet" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">💰 Wallet</h2>
      <p>Balance: <span id="balance">0</span> coins</p>
      <button onclick="requestWithdraw()" class="mt-2 bg-yellow-500 text-white px-3 py-1 rounded">Request Withdraw</button>
      <div id="income-history" class="mt-4"></div>
    </div>

    <div id="profile" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">👤 Profile</h2>
      <p>Your Telegram ID: <span id="tg-id"></span></p>
    </div>

    <div id="admin" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">🧑‍💼 Admin Panel</h2>
      <div id="withdraw-requests"></div>
    </div>

    <div id="music" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">🎵 Music Library</h2>
      <input type="text" id="music-title" placeholder="Title" class="border p-1 mb-2 w-full">
      <input type="file" id="music-file" accept="audio/*" class="mb-2">
      <button onclick="uploadMusic()" class="bg-indigo-500 text-white px-4 py-1 rounded">Upload Music</button>
      <div id="music-list" class="mt-4"></div>
    </div>

    <div id="notifications" class="screen p-4 hidden">
      <h2 class="text-xl font-bold mb-2">🔔 Notifications</h2>
      <ul id="notification-list"></ul>
    </div>
  </div>

  <script>
    const supabase = supabase.createClient('https://ydtpzbwauxqxqouysaau.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdHB6YndhdXhxeHFvdXlzYWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjI0MjIsImV4cCI6MjA2NDczODQyMn0.mAUxZcqBLQdzOih6Ty2Eoy_vXmR94BwAcTCQ1j2_1M0');
    let tgUser;

    window.Telegram.WebApp.ready();
    tgUser = window.Telegram.WebApp.initDataUnsafe.user;
    document.getElementById('tg-id').innerText = tgUser.id;

    function navigate(tab) {
      document.querySelectorAll('.screen').forEach(div => div.classList.add('hidden'));
      document.getElementById(tab).classList.remove('hidden');
    }

    async function loadFeed() {
      const { data, error } = await supabase.from('videos').select('*').order('created_at', { ascending: false });
      const feed = document.getElementById('video-feed');
      feed.innerHTML = '';
      data.forEach(video => {
        const div = document.createElement('div');
        div.innerHTML = `
          <video src="${video.url}" controls class="w-full"></video>
          <div class="flex items-center justify-between">
            <button onclick="likeVideo('${video.id}', this)" class="text-red-500 like-btn">♥️ Like</button>
            <button onclick="commentVideo('${video.id}')" class="text-blue-500">💬 Comment</button>
            <button onclick="shareVideo('${video.id}')" class="text-green-500">🔗 Share</button>
          </div>
        `;
        feed.appendChild(div);
      });
    }

    async function likeVideo(videoId, btn) {
      await supabase.from('likes').insert({ video_id: videoId, user_id: tgUser.id });
      btn.classList.add('like-animate');
      setTimeout(() => btn.classList.remove('like-animate'), 300);
    }

    function commentVideo(videoId) {
      const comment = prompt('Enter your comment:');
      if (comment) {
        supabase.from('comments').insert({ video_id: videoId, user_id: tgUser.id, text: comment });
        alert('Comment added');
      }
    }

    async function shareVideo(videoId) {
      const link = `https://shortie.app/v/${videoId}`;
      await navigator.clipboard.writeText(link);
      alert('Video link copied!');
    }

    async function uploadVideo() {
      const file = document.getElementById('video-file').files[0];
      const musicId = document.getElementById('music-id').value;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'shortie_miniapp');

      const cloudRes = await fetch('https://api.cloudinary.com/v1_1/djxcrk7yo/video/upload', {
        method: 'POST',
        body: formData
      });

      const cloudData = await cloudRes.json();
      const videoUrl = cloudData.secure_url;

      await supabase.from('videos').insert({ url: videoUrl, user_id: tgUser.id, music_id: musicId });
      alert('Uploaded!');
      loadFeed();
    }

    async function sendMessage() {
      const text = document.getElementById('chat-message').value;
      await supabase.from('messages').insert({ sender_id: tgUser.id, receiver_id: tgUser.id, text });
    }

    async function requestWithdraw() {
      await supabase.from('withdraw_requests').insert({ user_id: tgUser.id, amount: 50 });
      alert('Withdraw Requested');
    }

    async function uploadMusic() {
      const file = document.getElementById('music-file').files[0];
      const title = document.getElementById('music-title').value;
      const path = `music/${tgUser.id}-${file.name}`;
      await supabase.storage.from('music').upload(path, file);
      const { publicURL } = supabase.storage.from('music').getPublicUrl(path).data;
      await supabase.from('music_library').insert({ title, url: publicURL, uploaded_by: tgUser.id });
      alert('Music Uploaded');
    }

    async function loadWallet() {
      const { data: user } = await supabase.from('users').select('*').eq('telegram_id', tgUser.id).single();
      document.getElementById('balance').innerText = user?.balance || 0;
      const { data: earnings } = await supabase.from('earnings').select('*').eq('user_id', tgUser.id);
      const history = document.getElementById('income-history');
      history.innerHTML = earnings.map(e => `<p>${e.type} +${e.amount} coins</p>`).join('');
    }

    async function loadAdminPanel() {
      if (tgUser.username !== 'riponmondol420') return;
      const { data } = await supabase.from('withdraw_requests').select('*').eq('status', 'pending');
      const panel = document.getElementById('withdraw-requests');
      panel.innerHTML = data.map(w => `
        <div class="border p-2 mb-2">
          <p>User: ${w.user_id}</p>
          <p>Amount: ${w.amount}</p>
          <button onclick="updateWithdraw('${w.id}', 'approved')" class="bg-green-500 text-white px-2">Approve</button>
          <button onclick="updateWithdraw('${w.id}', 'rejected')" class="bg-red-500 text-white px-2">Reject</button>
        </div>
      `).join('');
    }

    async function updateWithdraw(id, status) {
      await supabase.from('withdraw_requests').update({ status }).eq('id', id);
      alert(`Withdraw ${status}`);
      loadAdminPanel();
    }

    async function loadNotifications() {
      const { data } = await supabase.from('notifications').select('*').eq('user_id', tgUser.id);
      const list = document.getElementById('notification-list');
      const badge = document.getElementById('notification-badge');
      list.innerHTML = data.map(n => `<li>${n.message}</li>`).join('');
      badge.innerText = data.length;
      badge.style.display = data.length > 0 ? 'inline' : 'none';
    }

    loadFeed();
    loadWallet();
    loadAdminPanel();
    loadNotifications();
  </script>
</body>
        </html>
